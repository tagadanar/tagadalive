/**
 * UtilityEffects - Handlers for utility effects
 * 
 * Handles: EFFECT_KILL, EFFECT_REMOVE_SHACKLES, EFFECT_ADD_STATE,
 *          EFFECT_PROPAGATION, EFFECT_STEAL_LIFE
 */

// Register all utility effect handlers
Consequences.registerHandlers([
	EFFECT_KILL: (ItemEffect effect, Entity entitySource, Entity entityTarget, real ratioDmg, Consequences conseq) => void {
		// Direct kill (only works on bulbs currently)
		// Could also add full life damage consequence for scoring
		// If killing leeks/towers becomes possible, need to check win conditions & kill bulbs
		conseq.addKill(entityTarget)
	},

	EFFECT_PROPAGATION: (ItemEffect effect, Entity entitySource, Entity entityTarget, real ratioDmg, Consequences conseq) => void {
		// Handled in Position scoring as this is a placement issue
		// No direct consequence here
	},

	EFFECT_REMOVE_SHACKLES: (ItemEffect effect, Entity entitySource, Entity entityTarget, real ratioDmg, Consequences conseq) => void {
		// Remove all negative shackle effects from target
		for (EntityEffect entityEffect in entityTarget.effects) {
			if (entityEffect.type != EFFECT_SHACKLE_STRENGTH &&
				entityEffect.type != EFFECT_SHACKLE_MAGIC &&
				entityEffect.type != EFFECT_SHACKLE_AGILITY &&
				entityEffect.type != EFFECT_SHACKLE_WISDOM &&
				entityEffect.type != EFFECT_SHACKLE_TP &&
				entityEffect.type != EFFECT_SHACKLE_MP) continue

			integer alreadyAltered = conseq.getEffectTypeAlteration(entityTarget, entityEffect.type)
			integer remaining = entityEffect.value - alreadyAltered
			if (remaining <= 0) continue

			integer? stat = Stats.entityEffectType_to_stats[entityEffect.type]
			if (stat == null) continue
			conseq.add(entityTarget, stat!, remaining)
			conseq.addEffectTypeAlteration(entityTarget, entityEffect.type, remaining)
		}
	},

	EFFECT_STEAL_LIFE: (ItemEffect effect, Entity entitySource, Entity entityTarget, real ratioDmg, Consequences conseq) => void {
		// Heals caster for total value of preceding effect (e.g., Quantum Rifle: NOVA_DAMAGE -> STEAL_LIFE)
		integer totalValue = conseq.lastEffectTotalValue
		if (totalValue <= 0) return;
		integer hpMissing = conseq.getHPMissing(entityTarget)
		integer healAmount = min(totalValue, hpMissing)
		if (healAmount > 0) conseq.add(entityTarget, Stats.HP, healAmount)
	},

	EFFECT_ADD_STATE: (ItemEffect effect, Entity entitySource, Entity entityTarget, real ratioDmg, Consequences conseq) => void {
		// Applies special states (stunned, burning, etc.)
		// States have various effects:
		// - stunned = skip turn
		// - burning = DoT
		// - etc.
		// TODO: proper state tracking - would need state->effect mapping
	}
])
